# 内联准备

## 概述

传统的数据准备方法是将原始数据源（通常是本地文件系统中的一个文件夹）转换为一堆不超过 32GiB 的 CAR 文件。这给数据准备者带来了一个新的问题。如果他们要准备一个 PiB 的数据集，他们需要额外提供一个 PiB 的存储服务器来存储这些 CAR 文件。

内联准备通过将这些 CAR 文件的块映射回原始数据源来解决了这个问题，因此不需要存储导出的 CAR 文件。

## CAR 检索的工作原理

使用内联准备，CAR 文件可以通过 HTTP 服务提供，使用元数据数据库和原始数据源，因为它知道如何将 CAR 文件的某些字节范围映射回原始数据源。

要通过 HTTP 提供 CAR 文件，请简单地启动内容提供程序，并可选择将其放在反向代理后面。

```sh
singularity run content-provider
```

这会引发另一个问题，如果数据源已经是一个远程存储系统，比如 S3 或 FTP，文件内容仍然通过 singularity content provider 代理到存储提供程序。

我们有一个解决方案来解决这个问题，使用 singularity metadata API 和 singularity download 工具.

```bash
singularity run api
singularity download <piece_cid>
```

Singularity metadata API 将返回如何从原始数据源组装 CAR 文件的计划，singularity download 工具将解释这个计划，并从原始数据流向本地 CAR 文件。在中间过程中没有进行任何转换或组装，一切都以流的方式工作。

元数据 API 并不返回访问原始数据源所需的任何凭据，所以存储提供者需要从数据源获取其自己的访问凭据，并将此凭据提供给 singularity download 命令。

## 开销

内联准备带来的开销非常小。

由于我们需要为每个数据块存储一个数据库行，所以我们需要为准备的每 1MiB 数据块使用 100 字节。对于 1PiB 数据集，该数据库将使用 10TiB 的磁盘空间来存储此映射元数据。这通常不是一个问题，但对于包含大量小文件的数据集，磁盘开销将更大。

稍后，当我们从原始数据源动态重新生成 CAR 文件时，我们将需要在数据库中查找这些映射。这通常不是一个问题，因为每秒 1GB 的带宽可以转换为在数据库中进行 1000 次查询，这远低于所有支持的数据库后端的瓶颈，并且未来可能有优化来减少这样的开销。

## 启用内联准备

对于不需要加密的所有数据集，内联准备始终是启用的。当指定输出目录创建数据集时，CAR 文件将被导出到这些目录中。在这种情况下，CAR 检索请求将首先从这些目录中提供服务，如果用户删除了这些 CAR 文件，则会回退到原始数据源。

## 相关资源

[download.md](../cli-reference/download.md "mention")