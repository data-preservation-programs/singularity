# インライン準備

## 概要

従来のデータ準備の方法は、元のデータソース（おそらくローカルファイルシステムのフォルダ）を、32GiB未満のCARファイルの束に変換することです。これにより、データ準備者に新たな問題が発生します。1 PiBのデータセットを準備する場合、CARファイルを保存するためにさらに1 PiBのストレージサーバを用意する必要があります。

インライン準備では、これらのCARファイルのブロックを元のデータソースにマッピングすることで、エクスポートされたCARファイルを保存する必要がなくなります。

## CARの取得方法

インライン準備では、CARファイルはHTTP経由でメタデータデータベースと元のデータソースを使用して提供できます。特定のバイト範囲のCARファイルを元のデータソースにマッピングする方法がわかっているためです。&#x20;

CARファイルをHTTP経由で提供するには、単にコンテンツプロバイダを起動し、必要に応じてリバースプロキシの背後に配置します。

```sh
singularity run content-provider
```

これにより、別の課題が生じます。データソースがすでにリモートストレージシステム（S3やFTPなど）である場合、ファイルの内容はまだシンギュラリティコンテンツプロバイダを介してストレージプロバイダを経由してプロキシされます。

この問題を解決するためのソリューションがあります。シンギュラリティメタデータAPIとシンギュラリティダウンロードユーティリティを使用します。

```bash
singularity run api
singularity download <piece_cid>
```

シンギュラリティメタデータAPIは、元のデータソースからCARファイルを組み立てる方法についての計画を返し、シンギュラリティダウンロードユーティリティはこの計画を解釈し、元のデータからローカルのCARファイルにストリーミングします。中間で変換や組み立ては行われず、すべてがストリームで動作します。

メタデータAPIは、元のデータソースからデータにアクセスするために必要な資格情報を返さないため、ストレージプロバイダはデータソースへのアクセス権を取得し、それをシンギュラリティのダウンロードコマンドに提供する必要があります。

## オーバーヘッド

インライン準備には非常に小さいオーバーヘッドがあります。

データの各ブロックには、データベースの行を保存するために100バイト必要です。つまり、準備するデータの1MiBブロックごとに100バイト必要です。1 PiBのデータセットの場合、このマッピングメタデータの保存には10 TiBのディスクスペースが必要です。これは通常は問題になりませんが、ファイル数が多く小さいデータセットの場合、ディスクのオーバーヘッドが大きくなります。

後で元のデータソースからCARファイルを動的に再生成する際に、データベース内のこれらのマッピングをチェックする必要があります。これは通常は問題になりません。なぜなら、1GB/秒の帯域幅はデータベース内の1000エントリのルックアップに相当し、これはすべてのサポートされているデータベースバックエンドのボトルネックを下回っているからです。さらに、このようなオーバーヘッドを低減するための将来の最適化が行われる可能性があります。

## インライン準備の有効化

インライン準備は、暗号化が必要ないすべてのデータセットで常に有効になっています。データセットが出力ディレクトリを指定して作成されると、CARファイルはそれらのディレクトリにエクスポートされます。この場合、CARの取得リクエストはまずこれらのディレクトリから提供され、ユーザーによってこれらのCARファイルが削除された場合には元のデータソースにフォールバックします。

## 関連リソース

[download.md](../cli-reference/download.md "mention")