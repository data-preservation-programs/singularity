---
description: シンギュラリティでのデータ準備プロセスを理解したい開発者向けに、このドキュメントは技術的な概要を提供します
---

# シンギュラリティのデータ準備のアーキテクチャ

![シンギュラリティのデータ準備モデル](data-prep-model.jpg)

# データセットとソース

データセットは、レプリケーションのための共通ポリシーと1つ以上の関連するFilecoinウォレットを持つデータのセットです。

各データセットは、データのソースを1つ以上持つことができます。ソースは単にデータのフォルダへのポインタであり、[RClone](https://github.com/rclone/rclone)でサポートされるストレージに格納されるデータを指します。ストレージには、ローカルファイルストレージも含まれます。

データ準備は、シンギュラリティのユーザーが次の手順を実行することで開始されます。
1. データセットの作成
2. データセットにソースを追加
3. データ準備ワーカーの開始

# スキャン

データ準備の最初のステージは、データソースをスキャンして、それが含むファイルとフォルダのディレクトリツリー構造と、ファイルをCARファイルにどのようにチャンク分割するかの計画を構築することです。

データソースのディレクトリツリー構造を表現するために使用するモデルは、DirectoryとItemです（ディレクトリはフォルダを、アイテムはファイルを表します）。スキャンプロセスでは、RCloneを使用してデータソースのディレクトリ構造をマップし、このディレクトリ構造からディレクトリとアイテムのモデルを作成します。データソースのルートディレクトリから開始し、このディレクトリはデータソースの登録時に作成されます。

データソースの各アイテムについて、スキャンプロセスはまた、1GBまでのファイルの連続する部分を表すItemPartsも作成します（このサイズは設定可能です）。さらに、ItemPartsのセットはChunkに追加されます。Chunkは単に、32GBのピースに格納できるだけのItemPartsのリストです。

スキャンプロセスの終了時には、アイテムごとにItemPartsで分割され、ディレクトリごとにアイテムがリスト化されたDirectoryツリーが得られます。さらに、ItemPartsのセット（1つのピースに格納するための十分な量）にリンクするChunkのセットもあります。

データソースは変更される可能性があるため、ファイルとフォルダが追加、変更、削除されるとスキャンを行うことがあります。

# パッキング

ソースがスキャンされたら、CARファイルにパックする準備ができています。パッキングとは、Chunkを実際のCARファイルに変換するプロセスです。

CARファイルをパックするために、Chunkの各ItemPartを読み取り、指定されたブロックサイズのIPLD Rawブロックにチャンク化し、CARに書き込みます。すべての生のブロックが書き込まれた後、ItemPartに複数の生のブロックが含まれている場合、UnixFSの中間ノードブロックのツリーが組み立てられ、生のブロックをリンクし、アイテムパートのルートCIDを作成します。このプロセスが完了すると、Chunk内のすべてのItemPartの生のブロックとUnixFSの中間ノードブロックが含まれるCARファイルが得られます。

パッキングプロセスの最後に、SingularityはCarモデルをデータベースに書き込み、Carファイルを表現します。また、CAR内のすべてのブロックに対するCarBlockも書き込みます。

Carの書き込みが完了すると、ディレクトリとアイテムに戻ります。すべてのItemPartが書き込まれたアイテムについて、アイテムのすべてのItemPartを接続し、アイテムを1つのUnixFSファイルに結合するための追加のUnixFS中間ノードツリーを作成します。また、各ディレクトリに対してUnixFSディレクトリノードを組み立てて更新します。このデータは一時的にデータベースに保存され、ディレクトリオブジェクトにリンクされます。

パッキングプロセスが完了すると、データソースのすべてのItemPartを格納するためのCARファイルがあります。ただし、この時点では、データソースのディレクトリ（ディレクトリ）とファイル（アイテム）を表すUnixFS DAGを組み立てたままであり、それ自体をCARにシリアライズしてFilecoinに格納していません。

# Daggen

ファイルとディレクトリの構造は時間とともに変化するため、この構造のスナップショットをFilecoinに保存するには、手動の準備段階として「Daggen」と呼ばれるステップがあります。ユーザーがこのステップを別途起動すると、パック中に組み立てられたUnixFS DAGツリーがCARにシリアライズされ、Filecoinに保存されます。これが完了すると、データ準備プロセスで書き込まれたすべてのCARをFilecoinに格納するなら、データソースの完全なスナップショットを取得するために必要なすべてがFilecoinに保存されます。