name: CI (Podman Devcontainer)

on:
  push:
    branches: [ local/devcontainer ]
  pull_request:
    branches: [ local/devcontainer ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Disable Docker engine and install podman-docker
        run: |
          set -euo pipefail
          sudo systemctl stop docker.socket docker || true
          sudo systemctl disable docker.socket docker || true
          sudo systemctl mask docker.socket docker || true
          sudo service docker stop || true
          sudo apt-get update
          sudo apt-get install -y podman-docker
          docker --version
          podman --version

      - name: Start Podman service socket (Docker-compatible)
        run: |
          set -euo pipefail
          podman info
          nohup podman system service -t 0 unix:///tmp/podman.sock > podman-service.log 2>&1 &
          echo "DOCKER_HOST=unix:///tmp/podman.sock" >> $GITHUB_ENV
          echo "DOCKER_CLI_HINTS=false" >> $GITHUB_ENV

      - name: Install Dev Containers CLI
        run: |
          npm i -g @devcontainers/cli
          devcontainer --version

      - name: Build devcontainer (Podman)
        run: |
          devcontainer up --workspace-folder . --remove-existing-container --id-label ci=podman

      - name: Run tests in devcontainer
        run: |
          devcontainer exec --workspace-folder . -- bash -lc 'go version && go test ./...'


