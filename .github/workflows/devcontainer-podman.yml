name: CI (Podman Devcontainer)

on:
  push:
    branches: [ local/devcontainer ]
  pull_request:
    branches: [ local/devcontainer ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show Podman version
        run: podman --version

      - name: Start Podman Docker-compatible service
        run: |
          set -euo pipefail
          podman info
          nohup podman system service -t 0 tcp:127.0.0.1:8080 > podman-service.log 2>&1 &
          echo "DOCKER_HOST=tcp://127.0.0.1:8080" >> $GITHUB_ENV

      - name: Install Dev Containers CLI
        run: |
          npm i -g @devcontainers/cli
          devcontainer --version

      - name: Build devcontainer (Podman)
        run: |
          devcontainer up --workspace-folder . --remove-existing-container --id-label ci=podman

      - name: Run tests in devcontainer
        run: |
          devcontainer exec --workspace-folder . -- bash -lc 'go version && go test ./...'


